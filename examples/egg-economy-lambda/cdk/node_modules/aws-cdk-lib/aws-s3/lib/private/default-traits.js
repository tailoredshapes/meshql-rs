"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var aws_iam_1=()=>{var tmp=require("../../../aws-iam");return aws_iam_1=()=>tmp,tmp},aws_kms_1=()=>{var tmp=require("../../../aws-kms");return aws_kms_1=()=>tmp,tmp},core_1=()=>{var tmp=require("../../../core");return core_1=()=>tmp,tmp},helpers_internal_1=()=>{var tmp=require("../../../core/lib/helpers-internal");return helpers_internal_1=()=>tmp,tmp},s3_generated_1=()=>{var tmp=require("../s3.generated");return s3_generated_1=()=>tmp,tmp};class EncryptedBucketFactory{forResource(resource){return ifCfnBucket(resource,r=>new EncryptedCfnBucket(r))}}class EncryptedCfnBucket{bucket;env;constructor(bucket){this.bucket=bucket,this.env=bucket.env}grantOnKey(grantee,...actions){const key=tryFindKmsKeyforBucket(this.bucket);return{grant:key?aws_kms_1().KeyGrants.fromKey(key).actions(grantee,...actions):void 0}}}class BucketWithPolicyFactory{forResource(resource){return ifCfnBucket(resource,r=>new CfnBucketWithPolicy(r))}}class CfnBucketWithPolicy{bucket;env;policy;policyDocument;constructor(bucket){this.bucket=bucket,this.env=bucket.env}addToResourcePolicy(statement){return this.policy||(this.policy=new(s3_generated_1()).CfnBucketPolicy(this.bucket,"S3BucketPolicy",{bucket:this.bucket.ref,policyDocument:{Statement:[]}})),this.policyDocument||(this.policyDocument=aws_iam_1().PolicyDocument.fromJson(this.policy.policyDocument??{Statement:[]})),this.policyDocument.addStatements(statement),this.policy.policyDocument=this.policyDocument.toJSON(),{statementAdded:!0,policyDependable:this.policy}}}function ifCfnBucket(resource,factory){if(!s3_generated_1().CfnBucket.isCfnBucket(resource))throw new(core_1()).ValidationError(`Construct ${resource.node.path} is not of type CfnBucket`,resource);return factory(resource)}function tryFindKmsKeyforBucket(bucket){const cfnBucket=tryFindBucketConstruct(bucket),kmsMasterKeyId=cfnBucket&&Array.isArray(cfnBucket.bucketEncryption?.serverSideEncryptionConfiguration)?cfnBucket.bucketEncryption.serverSideEncryptionConfiguration[0]?.serverSideEncryptionByDefault?.kmsMasterKeyId:void 0;if(kmsMasterKeyId)return(0,helpers_internal_1().findClosestRelatedResource)(bucket,"AWS::KMS::Key",(_,key)=>key.ref===kmsMasterKeyId||key.attrKeyId===kmsMasterKeyId||key.attrArn===kmsMasterKeyId)}function tryFindBucketConstruct(bucket){return(0,helpers_internal_1().findL1FromRef)(bucket,"AWS::S3::Bucket",(cfn,ref)=>ref.bucketRef==cfn.bucketRef)}aws_iam_1().DefaultEncryptedResourceFactories.set("AWS::S3::Bucket",new EncryptedBucketFactory),aws_iam_1().DefaultPolicyFactories.set("AWS::S3::Bucket",new BucketWithPolicyFactory);
